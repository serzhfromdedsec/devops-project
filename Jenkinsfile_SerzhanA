pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    APP_DIR   = "app/online-library"
    IMAGE_NAME = "serzhan/todo-app"
    IMAGE_TAG  = "${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'git rev-parse --short HEAD'
      }
    }

    stage('Build (Gradle Wrapper)') {
      steps {
        sh "ls -la ${APP_DIR}"
        sh "test -f ${APP_DIR}/gradlew"
        sh "chmod +x ${APP_DIR}/gradlew"
        sh "cd ${APP_DIR} && ./gradlew clean build"
      }
      post {
        always {
          archiveArtifacts artifacts: "${APP_DIR}/build/libs/*.jar", allowEmptyArchive: true
        }
      }
    }

    stage('Test') {
      steps {
        sh "cd ${APP_DIR} && ./gradlew test"
      }
      post {
        always {
          junit testResults: "${APP_DIR}/build/test-results/test/*.xml", allowEmptyResults: true
        }
      }
    }

    stage('Static Analysis (optional)') {
      steps {
        sh "cd ${APP_DIR} && ./gradlew checkstyleMain checkstyleTest || true"
        sh "cd ${APP_DIR} && ./gradlew spotbugsMain spotbugsTest || true"
      }
      post {
        always {
          archiveArtifacts artifacts: "${APP_DIR}/build/reports/**", allowEmptyArchive: true
        }
      }
    }

    stage('Docker Build (dynamic tag)') {
      steps {
        sh """
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -f docker/Dockerfile_SerzhanA .
          docker images | head
        """
      }
    }

    stage('Docker Push') {
      steps {
        echo "Docker push skipped: configure registry credentials when ready."
      }
    }

    stage('Deploy (main only)') {
      when { branch 'main' }
      steps {
        echo "Deploy runs only on main branch."
      }
    }
  }

  post {
    success { echo "PIPELINE SUCCESS" }
    failure { echo "PIPELINE FAILED" }
  }
}
