pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    // Поменяй IMAGE_NAME под свой registry/неймспейс позже.
    // Сейчас можно оставить так, чтобы Docker Build работал локально.
    IMAGE_NAME = "serzhan/todo-app"
    IMAGE_TAG  = "${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'git rev-parse --short HEAD'
        sh 'git branch --show-current || true'
      }
    }

    stage('Build (Gradle Wrapper)') {
      steps {
        sh 'ls -la'
        sh 'test -f ./gradlew'
        sh 'chmod +x ./gradlew'
        sh './gradlew clean build'
      }
      post {
        always {
          archiveArtifacts artifacts: 'build/libs/*.jar', allowEmptyArchive: true
        }
      }
    }

    stage('Test') {
      steps {
        sh './gradlew test'
      }
      post {
        always {
          junit testResults: 'build/test-results/test/*.xml', allowEmptyResults: true
        }
      }
    }

    stage('Static Analysis (optional)') {
      steps {
        // Если в проекте настроен Checkstyle/SpotBugs — выполнится.
        // Если нет — не завалим сборку (|| true).
        sh './gradlew checkstyleMain checkstyleTest || true'
        sh './gradlew spotbugsMain spotbugsTest || true'
      }
      post {
        always {
          archiveArtifacts artifacts: 'build/reports/**', allowEmptyArchive: true
        }
      }
    }

    stage('Docker Build (dynamic tag)') {
      steps {
        sh """
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            -f docker/Dockerfile_SerzhanA .
          docker images | head
        """
      }
    }

    stage('Docker Push') {
      steps {
        echo "Docker push skipped: configure registry credentials when ready."
      }
    }

    stage('Deploy (main only)') {
      when {
        branch 'main'
      }
      steps {
        echo "Deploy runs only on main branch."
      }
    }
  }

  post {
    success {
      echo "PIPELINE SUCCESS"
    }
    failure {
      echo "PIPELINE FAILED"
    }
  }
}

