pipeline {
  agent any

  options {
    timestamps()
  }

  environment {
    IMAGE_NAME = "serzhfromdedsec/devops-project"
    IMAGE_TAG  = "${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'git branch --show-current'
      }
    }

    stage('Build') {
      steps {
        sh 'chmod +x ./gradlew'
        sh './gradlew clean build'
      }
    }

    stage('Test') {
      steps {
        sh './gradlew test'
      }
    }

    stage('Docker Build') {
      steps {
        sh """
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} \
          -f docker/Dockerfile_SerzhanA .
        """
      }
    }

    stage('Docker Push') {
      steps {
        echo "Docker push skipped (no registry credentials configured)"
      }
    }

    stage('Deploy (main only)') {
      when {
        branch 'main'
      }
      steps {
        echo "Deploying application from main branch"
      }
    }
  }

  post {
    success {
      echo "PIPELINE SUCCESS"
    }
    failure {
      echo "PIPELINE FAILED"
    }
  }
}

